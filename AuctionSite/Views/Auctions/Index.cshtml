@model IEnumerable<AuctionSite.Models.AuctionItem>

@{
    ViewData["Title"] = "オークション一覧";
}

<h1>オークション一覧</h1>

<p>
    <a asp-action="Create" class="btn btn-primary">新しい出品</a>
</p>

<table class="table">
    <thead>
        <tr>
            <th>画像</th>
            <th>タイトル</th>
            <th>開始価格</th>
            <th>登録日時 (日本時間)</th>
            <th>ステータス</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model)
{
    var isEnded = item.IsEnded;
    var remaining = item.RemainingTime;

    <tr>
        <td>
            @if (!string.IsNullOrEmpty(item.ImageFileName))
            {
                <img src="~/uploads/@item.ImageFileName"
                     style="width:80px;height:60px;object-fit:cover;border-radius:8px;" />
            }
        </td>
        <td>@item.Title</td>
        <td>@item.StartPrice.ToString("0.00")</td>
        <td>@item.CreatedAt.AddHours(9).ToString("yyyy/MM/dd HH:mm")</td>
        <td>
            @if (isEnded)
            {
                <span class="badge bg-secondary">終了</span>
            }
            else
            {
                <span class="badge bg-success">出品中</span>
                @if (remaining != null)
                {
                    <span class="ms-1 small">
                        残り @remaining.Value.Days 日 @remaining.Value.Hours 時間
                    </span>
                }
            }
        </td>
        <td>
            <a asp-action="Details"
            asp-route-id="@item.Id"
            class="btn btn-sm btn-outline-secondary me-1">
                詳細
            </a>

            @{
                var idClaim = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                int currentUserId;
                var isOwner = int.TryParse(idClaim, out currentUserId) && item.SellerId == currentUserId;
            }

            @if (isOwner)
            {
                <a asp-action="Edit"
                asp-route-id="@item.Id"
                class="btn btn-sm btn-outline-primary me-1">
                    編集
                </a>
                <a asp-action="Delete"
                asp-route-id="@item.Id"
                class="btn btn-sm btn-outline-danger">
                    削除
                </a>
            }
        </td>

    </tr>
}

@section Scripts {
    <script>
        // Hub に接続
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/auctionHub")
            .withAutomaticReconnect()
            .build();

        // サーバーから "AuctionUpdated" が来たらページを再読み込み
        connection.on("AuctionUpdated", function () {
            // ほんの少し待ってから更新（DB反映が確実になるように）
            setTimeout(function () {
                location.reload();
            }, 300);
        });

        connection.start().catch(err => console.error(err.toString()));
    </script>
}

    </tbody>
</table>
